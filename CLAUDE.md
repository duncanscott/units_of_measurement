# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A data distribution package providing comprehensive units of measurement in both JSON and JSONL formats. Published to both npm and PyPI as `units-of-measurement`. No external runtime dependencies — uses only Node.js/Python standard libraries.

`jsonl/` is the source of truth. The `json/` directory contains the same datasets as JSON arrays and should be regenerated before release with `python3 scripts/convert_jsonl_to_json.py`.

Datasets loadable via the `load()` API: `units_of_measurement` (merged superset), `si_units` (SI units with all 24 prefixes), `uom` (from Rust `uom` crate, 117 quantities).

Additional JSONL files (not loadable via API):
- `units_with_ontologies.jsonl` — intermediate annotated copy used by the ontology pipeline
- `ontology_crosswalk_base_units.jsonl` — 7 SI base units with full UO/OM/UCUM cross-references
- `jsonl/focused/` — curated subsets generated by `scripts/generate_focused_lists.py`

## Architecture

The library exposes a single `load(dataset?)` function in both languages that reads a JSONL file and returns an array of unit objects.

- **`index.js`** — CommonJS entry point (`require`)
- **`index.mjs`** — ES Module entry point (`import`)
- **`units_of_measurement/__init__.py`** — Python package entry point

The Python package has a data path fallback: installed packages find data in `units_of_measurement/data/` (mapped via hatch wheel config), while running from source falls back to `jsonl/` at repo root.

## JSONL Schema (merged dataset)

The combination of `(unit, property)` is the unique key across all entries.

Each line is a JSON object with required fields: `unit`, `canonical_unit`, `prefix`, `symbol`, `plural`, `property`, `quantity`, `dimension`, `conversion_factor`, `reference_unit`, `system`.

Optional fields: `conversion_offset`, `alternate_unit`, `external_ids`, `ontology_metadata`.

Nullable: `prefix` (string or null).

- `canonical_unit` — no-whitespace form using `·` (multiplication) and `/` (division) delimiters, with superscript exponents (e.g., `meter/second²`)
- `quantity` — mirrors `property` in all entries
- `dimension` — SI base-exponent map with keys `L`, `M`, `T`, `I`, `Θ`, `N`, `J`. Only non-zero exponents included. Empty `{}` for dimensionless quantities.
- `external_ids` — object with optional keys `uo` (UO CURIE) and `ucum` (UCUM code)
- `ontology_metadata` — object with optional keys `uo` (label, definition) and `om` (uri, label, definition, ucum_code)

JSON Schemas for all JSONL files are in `schema/`. See `schema/README.md` for the schema-to-file mapping.

## Scripts

- `validate_uom.py` — structural validator for `jsonl/units_of_measurement.jsonl`
- `validate_schemas.py` — validates all JSONL files against their JSON Schemas (requires `pip install jsonschema`)
- `validate_ontology_annotations.py` — QA for ontology annotation coverage
- `annotate_with_ontologies.py` — enriches dataset with UO/OM/UCUM identifiers from ontology exports in `resource/bioportal/` (OM RDF, UO OWL, UO CSV)
- `apply_ontology_annotations.py` — copies annotations from `units_with_ontologies.jsonl` into the canonical dataset
- `generate_focused_lists.py` — derives curated subsets under `jsonl/focused/`
- `convert_jsonl_to_json.py` — regenerates `json/` as JSON arrays mirroring every JSONL file

## Valid Dataset Names

`"units_of_measurement"`, `"si_units"`, `"uom"` — both JS and Python validate this and throw on invalid input.

## Publishing

Version must be updated in three files: `package.json`, `pyproject.toml`, and `units_of_measurement/__init__.py`.

Workflow:
1. Bump version in all three files
2. Commit version bump and push to `main`
3. Create GitHub release: `gh release create vX.Y.Z --title "vX.Y.Z" --notes "..."`
4. Build and publish to PyPI: `rm -f dist/units_of_measurement-<old>* && python3 -m build && python3 -m twine upload dist/units_of_measurement-X.Y.Z*`
   - Requires `~/.pypirc` with PyPI API token (username `__token__`)
5. Publish to npm: `npm publish --otp=CODE`
   - Requires npm 2FA — ask user for OTP code

Notes:
- Always clean old dist files before building to avoid uploading stale artifacts
- Regenerate `json/` with `python3 scripts/convert_jsonl_to_json.py` before release
